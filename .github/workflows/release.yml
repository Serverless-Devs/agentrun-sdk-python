name: Release and Publish

on:
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Extract version
      run: echo "VERSION=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
    - name: Update pyproject.toml
      run: sed -i "s/version = \".*\"/version = \"${VERSION}\"/" pyproject.toml
    - name: Update __version__ in __init__.py
      run: |
        if grep -q "__version__" agentrun/__init__.py; then
          sed -i "s/__version__ = \".*\"/__version__ = \"${VERSION}\"/" agentrun/__init__.py
        else
          sed -i '1a __version__ = \"${VERSION}\"' agentrun/__init__.py
        fi
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add pyproject.toml agentrun/__init__.py
        git commit -m "Update version to ${VERSION}" || echo "No changes to commit"
        git push
    - name: Build package
      run: |
        python -m pip install --upgrade pip
        pip install build
        python -m build
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}